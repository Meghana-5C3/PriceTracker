{% extends "base.html" %}
{% block content %}

<!-- ‚îÄ‚îÄ Savings Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
{% if total_savings > 0 %}
<div class="alert border-0 mb-4 py-3 px-4 d-flex align-items-center gap-3"
    style="background:linear-gradient(135deg,rgba(34,197,94,.15),rgba(16,185,129,.1));border-left:4px solid #22c55e !important;">
    <i class="fa-solid fa-piggy-bank fa-2x text-success"></i>
    <div>
        <strong class="fs-5">üéâ You've saved ‚Çπ{{ "%.0f"|format(total_savings) }} so far!</strong>
        <div class="small text-muted">Keep tracking ‚Äî you're beating the market!</div>
    </div>
</div>
{% endif %}

<!-- ‚îÄ‚îÄ Hero Add Product ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="card border-0 shadow-sm mb-4 overflow-hidden"
    style="background:linear-gradient(135deg,#1e1b4b 0%,#1d4ed8 100%);">
    <div class="card-body py-4 px-4">
        <div class="text-white mb-3">
            <h4 class="fw-bold mb-1">üì¶ Track a Product Price</h4>
            <p class="mb-0 opacity-75 small">Paste any Amazon or Flipkart product URL ‚Äî we'll watch the price for you
                and alert you when it drops!</p>
        </div>
        <form action="{{ url_for('main.add_product') }}" method="POST" id="trackForm">
            <div class="d-flex gap-2 flex-column flex-md-row">
                <div class="flex-fill position-relative">
                    <span class="position-absolute top-50 translate-middle-y ms-3" style="z-index:5;">
                        <i class="fa-solid fa-link text-muted"></i>
                    </span>
                    <input type="url" name="url" id="urlInput" required
                        class="form-control form-control-lg ps-5 border-0" style="font-size:1rem;border-radius:10px;"
                        placeholder="https://www.amazon.in/dp/... or https://www.flipkart.com/...">
                </div>
                <button type="submit" id="trackBtn" class="btn btn-warning btn-lg fw-bold px-4"
                    style="border-radius:10px;min-width:140px;">
                    <i class="fa-solid fa-magnifying-glass-dollar me-2"></i>Track It!
                </button>
            </div>
            <div class="mt-2 d-flex gap-3 flex-wrap">
                <span class="text-white-50 small"><i class="fa-solid fa-clock me-1"></i>Auto-checked every ~6
                    hours</span>
                <span class="text-white-50 small"><i class="fa-solid fa-bell me-1"></i>Email alert on price drop</span>
                <span class="text-white-50 small"><i class="fa-solid fa-shield-halved me-1"></i>Free, no credit
                    card</span>
            </div>
        </form>
    </div>
</div>

<!-- ‚îÄ‚îÄ Stats Row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="row g-3 mb-4">
    {% for val, label, color, icon in [
    (products|length, 'Products Tracked', 'primary', 'fa-boxes-stacked'),
    (products|selectattr('trend','eq','down')|list|length, 'Prices Dropped', 'success', 'fa-arrow-trend-down'),
    (products|selectattr('trend','eq','up')|list|length, 'Prices Rising', 'danger', 'fa-arrow-trend-up'),
    ('‚Çπ' ~ ("%.0f"|format(total_savings)), 'Total Saved', 'warning', 'fa-piggy-bank'),
    ] %}
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center py-3">
                <i class="fa-solid {{ icon }} fa-lg text-{{ color }} mb-2 d-block"></i>
                <div class="fs-3 fw-bold text-{{ color }}">{{ val }}</div>
                <div class="small text-muted">{{ label }}</div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- ‚îÄ‚îÄ Product Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-bold mb-0"><i class="fa-solid fa-layer-group me-2 text-primary"></i>Your Tracked Products</h5>
    {% if products %}
    <span class="badge bg-primary rounded-pill">{{ products|length }}</span>
    {% endif %}
</div>

{% if not products %}
<!-- Empty State -->
<div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5">
        <div style="font-size:4rem;">üõí</div>
        <h5 class="mt-3 fw-bold">No products tracked yet</h5>
        <p class="text-muted mb-4">Paste an Amazon or Flipkart URL above to start tracking prices and get notified of
            drops.</p>
        <div class="row justify-content-center g-3 small text-muted">
            <div class="col-auto"><span class="badge bg-light text-dark py-2 px-3"><i
                        class="fa-brands fa-amazon me-1"></i>Amazon.in</span></div>
            <div class="col-auto"><span class="badge bg-light text-dark py-2 px-3"><i
                        class="fa-solid fa-bolt me-1 text-warning"></i>Flipkart</span></div>
            <div class="col-auto"><span class="badge bg-light text-dark py-2 px-3">+ more</span></div>
        </div>
    </div>
</div>

{% else %}
<div class="row g-4">
    {% for p in products %}
    <div class="col-xl-4 col-md-6">
        <div class="card border-0 shadow-sm product-card h-100 position-relative"
            style="transition:transform .15s;border-radius:14px;overflow:hidden;">

            <!-- Severity ribbon -->
            {% if p.trend == 'down' and p.severity == 'mega' %}
            <div class="severity-ribbon mega">üöÄ MEGA DEAL</div>
            {% elif p.trend == 'down' and p.severity == 'hot' %}
            <div class="severity-ribbon hot">üî• HOT DEAL</div>
            {% endif %}

            <!-- Top: Image + Name -->
            <div class="d-flex align-items-center gap-3 p-3 border-bottom">
                <img src="{{ p.image }}" class="rounded"
                    style="width:60px;height:60px;object-fit:contain;flex-shrink:0;"
                    onerror="this.src='https://placehold.co/60x60/e9ecef/6c757d?text=N/A'" alt="">
                <div class="flex-fill min-w-0">
                    <div class="fw-semibold lh-sm"
                        style="font-size:.88rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
                        {{ p.name }}
                    </div>
                    {% if p.trend == 'pending' %}
                    <span class="badge bg-warning-subtle text-warning mt-1"><i
                            class="fa-solid fa-spinner fa-spin me-1"></i>Fetching‚Ä¶</span>
                    {% elif p.trend == 'down' %}
                    <span class="badge bg-success-subtle text-success mt-1"><i
                            class="fa-solid fa-arrow-down me-1"></i>Price Drop</span>
                    {% elif p.trend == 'up' %}
                    <span class="badge bg-danger-subtle text-danger mt-1"><i class="fa-solid fa-arrow-up me-1"></i>Price
                        Rise</span>
                    {% else %}
                    <span class="badge bg-secondary-subtle text-secondary mt-1">Stable</span>
                    {% endif %}
                </div>
                <form action="{{ url_for('main.delete_product', product_id=p.id) }}" method="POST"
                    class="flex-shrink-0">
                    <button type="submit" class="btn btn-link text-danger p-0"
                        onclick="return confirm('Remove tracking for this product?')" title="Remove">
                        <i class="fa-solid fa-xmark fs-5"></i>
                    </button>
                </form>
            </div>

            <!-- Middle: Prices -->
            <div class="p-3">
                {% if p.trend == 'pending' %}
                <div class="text-muted text-center py-2 small">‚è≥ Price fetch in progress ‚Äî check back soon</div>
                {% else %}
                <div class="d-flex align-items-baseline gap-2 mb-2">
                    <span class="fs-3 fw-bold text-primary">‚Çπ{{ "%.0f"|format(p.current_price) if p.current_price else
                        '‚Äî' }}</span>
                    {% if p.previous_price and p.trend != 'unchanged' %}
                    <span class="text-muted text-decoration-line-through small">‚Çπ{{ "%.0f"|format(p.previous_price)
                        }}</span>
                    {% if p.diff_pct %}
                    <span class="badge {{ 'bg-success' if p.trend == 'down' else 'bg-danger' }}">
                        {{ '-' if p.trend == 'down' else '+' }}{{ p.diff_pct }}%
                    </span>
                    {% endif %}
                    {% endif %}
                </div>

                {% if p.lowest is not none %}
                <div class="row g-2 text-center small mb-2">
                    <div class="col-4">
                        <div class="rounded p-1" style="background:rgba(34,197,94,.1)">
                            <div class="text-muted" style="font-size:.65rem;">LOWEST</div>
                            <div class="fw-bold text-success">‚Çπ{{ "%.0f"|format(p.lowest) }}</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="rounded p-1" style="background:rgba(239,68,68,.08)">
                            <div class="text-muted" style="font-size:.65rem;">HIGHEST</div>
                            <div class="fw-bold text-danger">‚Çπ{{ "%.0f"|format(p.highest) }}</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="rounded p-1" style="background:rgba(99,102,241,.08)">
                            <div class="text-muted" style="font-size:.65rem;">AVERAGE</div>
                            <div class="fw-bold text-indigo">‚Çπ{{ "%.0f"|format(p.avg) }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Mini chart -->
                {% if p.history_points|length > 1 %}
                <canvas id="chart-{{ p.id }}" height="50" class="mb-2"></canvas>
                {% endif %}
                {% endif %}

                <div class="text-muted" style="font-size:.72rem;"><i class="fa-regular fa-clock me-1"></i>{{
                    p.checked_at }}</div>
            </div>

            <!-- Bottom: Actions -->
            <div class="px-3 pb-3 mt-auto d-flex gap-2">
                <a href="{{ url_for('main.product_detail', product_id=p.id) }}"
                    class="btn btn-primary btn-sm flex-fill fw-semibold">
                    <i class="fa-solid fa-chart-line me-1"></i>Full History
                </a>
                <a href="{{ p.url }}" target="_blank" class="btn btn-outline-secondary btn-sm px-3" title="Buy Now">
                    <i class="fa-solid fa-cart-shopping"></i>
                </a>
            </div>

        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Charts init -->
{% if products %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% for p in products %}
        {% if p.history_points | length > 1 %}
        (function () {
            const prices = {{ p.history_points| tojson
        }};
    const labels = {{ p.history_labels| tojson }};
    const color = '{{ "#22c55e" if p.trend == "down" else ("#ef4444" if p.trend == "up" else "#6366f1") }}';
    new Chart(document.getElementById('chart-{{ p.id }}'), {
        type: 'line',
        data: {
            labels, datasets: [{
                data: prices, borderColor: color, backgroundColor: color + '18',
                borderWidth: 1.5, fill: true, tension: 0.4, pointRadius: 0
            }]
        },
        options: {
            responsive: true, animation: false,
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => '‚Çπ' + c.parsed.y.toLocaleString('en-IN') } } },
            scales: {
                x: { display: false }, y: {
                    display: false, beginAtZero: false,
                    suggestedMin: Math.min(...prices) * 0.98, suggestedMax: Math.max(...prices) * 1.02
                }
            }
        }
    });
    }) ();
    {% endif %}
    {% endfor %}
});
</script>
{% endif %}

<!-- Track button loading feedback -->
<script>
    document.getElementById('trackForm').addEventListener('submit', function () {
        const btn = document.getElementById('trackBtn');
        const input = document.getElementById('urlInput');
        if (!input.value.trim()) return;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Tracking‚Ä¶';
        btn.disabled = true;
    });
</script>

{% endblock %}